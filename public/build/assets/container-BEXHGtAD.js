window.pacientesEncontrados=[];window.mostrarSeccion=function(e,n=!1){const t=document.getElementById("seccion_importar"),l=document.getElementById("seccion_registro"),c=document.querySelector(".contenedor_principal");t.style.display=e==="importar"?"block":"none",l.style.display=e==="registro"?"block":"none",e==="registro"&&n&&(limpiarFormulario(),c.innerHTML="")};window.limpiarFormulario=function(){const e=document.getElementById("frm_paciente");e.reset();const n=document.getElementById("url_store").value;e.action=n;const t=document.querySelector('input[name="_method"]');t&&t.remove(),document.getElementById("btn_guardar").value="Registrar",document.getElementById("txt_paciente_hc").value="",document.getElementById("cmb_plan").innerHTML='<option value="">--Seleccione--</option>'};window.trim_cadena=function(e){e&&e.value&&(e.value=e.value.trim())};window.getPlanes=function(e,n){const t=n==="import"?document.getElementById("cmb_plan_import"):document.getElementById("cmb_plan"),l=document.getElementById("url_obtener_planes").value;if(!e){t.innerHTML='<option value="">--Seleccione--</option>';return}fetch(`${l}/${e}/planes`).then(c=>c.json()).then(c=>{let o='<option value="">-- Seleccione el plan --</option>';c.forEach(r=>{o+=`<option value="${r.id}">${r.nombre}</option>`}),t.innerHTML=o}).catch(c=>console.error("Error:",c))};window.buscar_paciente=function(){let e=document.getElementById("txt_paciente_hc").value.trim();const n=document.querySelector(".contenedor_principal"),t=document.getElementById("url_buscar").value;n.innerHTML='<p style="padding:10px;">Buscando coincidencias...</p>',fetch(`${t}?search=${e}`).then(l=>l.json()).then(l=>{if(window.pacientesEncontrados=l,l.length===1)seleccionarPaciente(0);else if(l.length>1){document.getElementById("seccion_registro").style.display="none";let c=`
                    <div style="margin: 20px 0;">
                        <h3>Resultados de la búsqueda:</h3>
                        <table border="1" style="width:100%; border-collapse: collapse; background:white; font-size: 12px;">
                            <thead style="background: #e0e0e0; font-weight:bold;">
                                <tr>
                                    <th style="padding:8px;">Documento</th>
                                    <th style="padding:8px;">Nombre Completo</th>
                                    <th style="padding:8px;">Teléfono</th>
                                    <th style="padding:8px;">Email</th>
                                    <th style="padding:8px;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                `;l.forEach((o,r)=>{c+=`
                        <tr>
                            <td style="padding:8px; text-align:center;">${o.documento}</td>
                            <td style="padding:8px;">${o.nombres} ${o.apellidos}</td>
                            <td style="padding:8px; text-align:center;">${o.telefono||"-"}</td>
                            <td style="padding:8px;">${o.email||"-"}</td>
                            <td style="padding:8px; text-align:center;">
                                <input type="button" class="btnPrincipal" 
                                       value="Seleccionar" 
                                       onclick="seleccionarPaciente(${r})"
                                       style="cursor:pointer; padding: 5px 10px;">
                            </td>
                        </tr>
                    `}),c+="</tbody></table></div>",n.innerHTML=c}else n.innerHTML='<p style="padding:10px; color:red; font-weight:bold;">No se encontraron pacientes con ese criterio.</p>'}).catch(l=>{console.error("Error:",l),n.innerHTML='<p style="color:red;">Error en la búsqueda</p>'})};window.seleccionarPaciente=function(e){const n=window.pacientesEncontrados[e];n&&(cargarDatosPaciente(n),document.querySelector(".contenedor_principal").innerHTML="")};window.validarImportarPacientes=function(){const e=document.getElementById("fileISS"),n=document.getElementById("cmb_convenio_import"),t=document.getElementById("cmb_plan_import"),l=document.getElementById("url_importar").value,c=document.getElementById("token_csrf").value;if(!n.value){alert("Seleccione un convenio");return}if(!t.value){alert("Seleccione un plan para la importación");return}if(e.files.length===0){alert("Seleccione un archivo .csv");return}let o=new FormData;o.append("fileISS",e.files[0]),o.append("cmb_convenio",n.value),o.append("cmb_plan",t.value),o.append("_token",c),fetch(l,{method:"POST",body:o}).then(r=>r.json()).then(r=>{r.res==1?(alert(r.mensaje),location.reload()):alert("Error: "+(r.error||"Ocurrió un error desconocido"))}).catch(r=>{console.error("Error:",r),alert("Ocurrió un error al procesar el archivo")})};window.cargarDatosPaciente=function(e){mostrarSeccion("registro",!1),document.getElementById("btn_guardar").value="Actualizar Datos";const n=document.getElementById("frm_paciente");n.action=`/legacy/pacientes/${e.id}`;let t=document.querySelector('input[name="_method"]');t?t.value="PUT":(t=document.createElement("input"),t.type="hidden",t.name="_method",t.value="PUT",n.appendChild(t)),document.getElementById("cmb_tipo_documento").value=e.tipo_documento||"",document.getElementById("txt_numero_documento").value=e.documento||"";const l=(e.nombres||"").split(" ");document.getElementById("txt_nombre_1").value=l[0]||"",document.getElementById("txt_nombre_2").value=l.slice(1).join(" ")||"";const c=(e.apellidos||"").split(" ");document.getElementById("txt_apellido_1").value=c[0]||"",document.getElementById("txt_apellido_2").value=c.slice(1).join(" ")||"",document.getElementById("txt_fecha_nacimiento").value=e.fecha_nacimiento?e.fecha_nacimiento.split(" ")[0]:"";let o="";e.sexo==="F"&&(o="1"),e.sexo==="M"&&(o="2"),document.getElementById("cmb_sexo").value=o,document.getElementById("txt_telefono").value=e.telefono||"",document.getElementById("txt_email").value=e.email||"",document.getElementById("txt_direccion").value=e.direccion||"",document.getElementById("cmb_pais_nac").value=e.pais_nacimiento_cod||"",document.getElementById("cmb_pais_res").value=e.pais_residencia_cod||"1",document.getElementById("txt_estado_residencia").value=e.estado_residencia||"",document.getElementById("txt_municipio_residencia").value=e.municipio_residencia||"",document.getElementById("cmb_zona_residencia").value=e.zona_residencia||"",e.convenio_id&&(document.getElementById("cmb_convenio").value=e.convenio_id,getPlanes(e.convenio_id,"registro"),setTimeout(()=>{e.plan_id&&(document.getElementById("cmb_plan").value=e.plan_id)},500)),document.getElementById("cmb_tipoUsuario").value=e.tipo_usuario||"",document.getElementById("cmb_rango").value=e.rango||"",document.getElementById("cmb_estado_aseguradora").value=e.estado_aseguradora||"",document.getElementById("cmb_exento_cuota").value=e.exento_cuota==1||e.exento_cuota=="Si"?"1":"2",document.getElementById("txt_observ_paciente").value=e.observaciones||""};
