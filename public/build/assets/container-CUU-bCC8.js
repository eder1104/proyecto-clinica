document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector("nav .sm\\:ms-6 button"),t=document.querySelector("nav .sm\\:ms-6 .absolute");e&&t&&(e.addEventListener("click",function(n){n.stopPropagation();const o=window.getComputedStyle(t).display==="none";t.style.display=o?"block":"none",t.style.opacity=o?"1":"0"}),document.addEventListener("click",function(n){e.contains(n.target)||(t.style.display="none",t.style.opacity="0")}))});window.pacientesEncontrados=[];window.mostrarSeccion=function(e,t=!1){const n=document.getElementById("seccion_importar"),o=document.getElementById("seccion_registro"),c=document.querySelector(".contenedor_principal");n.style.display=e==="importar"?"block":"none",o.style.display=e==="registro"?"block":"none",e==="registro"&&t&&(limpiarFormulario(),c.innerHTML="")};window.limpiarFormulario=function(){const e=document.getElementById("frm_paciente");e.reset();const t=document.getElementById("url_store").value;e.action=t;const n=document.querySelector('input[name="_method"]');n&&n.remove(),document.getElementById("btn_guardar").value="Registrar",document.getElementById("txt_paciente_hc").value="",document.getElementById("cmb_plan").innerHTML='<option value="">--Seleccione--</option>'};window.trim_cadena=function(e){e&&e.value&&(e.value=e.value.trim())};window.getPlanes=function(e,t){const n=t==="import"?document.getElementById("cmb_plan_import"):document.getElementById("cmb_plan"),o=document.getElementById("url_obtener_planes").value;if(!e){n.innerHTML='<option value="">--Seleccione--</option>';return}fetch(`${o}/${e}/planes`).then(c=>c.json()).then(c=>{let l='<option value="">-- Seleccione el plan --</option>';c.forEach(d=>{l+=`<option value="${d.id}">${d.nombre}</option>`}),n.innerHTML=l}).catch(c=>console.error("Error:",c))};window.buscar_paciente=function(){let e=document.getElementById("txt_paciente_hc").value.trim();const t=document.querySelector(".contenedor_principal"),n=document.getElementById("url_buscar").value;t.innerHTML='<p style="padding:10px;">Buscando coincidencias...</p>',fetch(`${n}?search=${e}`).then(o=>o.json()).then(o=>{if(window.pacientesEncontrados=o,o.length===1)seleccionarPaciente(0);else if(o.length>1){document.getElementById("seccion_registro").style.display="none";let c=`
                    <div style="margin: 20px 0;">
                        <h3>Resultados de la búsqueda:</h3>
                        <table border="1" style="width:100%; border-collapse: collapse; background:white; font-size: 12px;">
                            <thead style="background: #e0e0e0; font-weight:bold;">
                                <tr>
                                    <th style="padding:8px;">Documento</th>
                                    <th style="padding:8px;">Nombre Completo</th>
                                    <th style="padding:8px;">Teléfono</th>
                                    <th style="padding:8px;">Email</th>
                                    <th style="padding:8px;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                `;o.forEach((l,d)=>{c+=`
                        <tr>
                            <td style="padding:8px; text-align:center;">${l.documento}</td>
                            <td style="padding:8px;">${l.nombres} ${l.apellidos}</td>
                            <td style="padding:8px; text-align:center;">${l.telefono||"-"}</td>
                            <td style="padding:8px;">${l.email||"-"}</td>
                            <td style="padding:8px; text-align:center;">
                                <input type="button" class="btnPrincipal" 
                                       value="Seleccionar" 
                                       onclick="seleccionarPaciente(${d})"
                                       style="cursor:pointer; padding: 5px 10px;">
                            </td>
                        </tr>
                    `}),c+="</tbody></table></div>",t.innerHTML=c}else t.innerHTML='<p style="padding:10px; color:red; font-weight:bold;">No se encontraron pacientes con ese criterio.</p>'}).catch(o=>{console.error("Error:",o),t.innerHTML='<p style="color:red;">Error en la búsqueda</p>'})};window.seleccionarPaciente=function(e){const t=window.pacientesEncontrados[e];t&&(cargarDatosPaciente(t),document.querySelector(".contenedor_principal").innerHTML="")};window.validarImportarPacientes=function(){const e=document.getElementById("fileISS"),t=document.getElementById("cmb_convenio_import"),n=document.getElementById("cmb_plan_import"),o=document.getElementById("url_importar").value,c=document.getElementById("token_csrf").value;if(!t.value){alert("Seleccione un convenio");return}if(!n.value){alert("Seleccione un plan para la importación");return}if(e.files.length===0){alert("Seleccione un archivo .csv");return}let l=new FormData;l.append("fileISS",e.files[0]),l.append("cmb_convenio",t.value),l.append("cmb_plan",n.value),l.append("_token",c),fetch(o,{method:"POST",body:l}).then(d=>d.json()).then(d=>{d.res==1?(alert(d.mensaje),location.reload()):alert("Error: "+(d.error||"Ocurrió un error desconocido"))}).catch(d=>{console.error("Error:",d),alert("Ocurrió un error al procesar el archivo")})};window.cargarDatosPaciente=function(e){mostrarSeccion("registro",!1),document.getElementById("btn_guardar").value="Actualizar Datos";const t=document.getElementById("frm_paciente");t.action=`/legacy/pacientes/${e.id}`;let n=document.querySelector('input[name="_method"]');n?n.value="PUT":(n=document.createElement("input"),n.type="hidden",n.name="_method",n.value="PUT",t.appendChild(n)),document.getElementById("cmb_tipo_documento").value=e.tipo_documento||"",document.getElementById("txt_numero_documento").value=e.documento||"";const o=(e.nombres||"").split(" ");document.getElementById("txt_nombre_1").value=o[0]||"",document.getElementById("txt_nombre_2").value=o.slice(1).join(" ")||"";const c=(e.apellidos||"").split(" ");document.getElementById("txt_apellido_1").value=c[0]||"",document.getElementById("txt_apellido_2").value=c.slice(1).join(" ")||"",document.getElementById("txt_fecha_nacimiento").value=e.fecha_nacimiento?e.fecha_nacimiento.split(" ")[0]:"";let l="";e.sexo==="F"&&(l="1"),e.sexo==="M"&&(l="2"),document.getElementById("cmb_sexo").value=l,document.getElementById("txt_telefono").value=e.telefono||"",document.getElementById("txt_email").value=e.email||"",document.getElementById("txt_direccion").value=e.direccion||"",document.getElementById("cmb_pais_nac").value=e.pais_nacimiento_cod||"",document.getElementById("cmb_pais_res").value=e.pais_residencia_cod||"1",document.getElementById("txt_estado_residencia").value=e.estado_residencia||"",document.getElementById("txt_municipio_residencia").value=e.municipio_residencia||"",document.getElementById("cmb_zona_residencia").value=e.zona_residencia||"",e.convenio_id&&(document.getElementById("cmb_convenio").value=e.convenio_id,getPlanes(e.convenio_id,"registro"),setTimeout(()=>{e.plan_id&&(document.getElementById("cmb_plan").value=e.plan_id)},500)),document.getElementById("cmb_tipoUsuario").value=e.tipo_usuario||"",document.getElementById("cmb_rango").value=e.rango||"",document.getElementById("cmb_estado_aseguradora").value=e.estado_aseguradora||"",document.getElementById("cmb_exento_cuota").value=e.exento_cuota==1||e.exento_cuota=="Si"?"1":"2",document.getElementById("txt_observ_paciente").value=e.observaciones||""};
