window.pacientesEncontrados=[];window.mostrarSeccion=function(e,o=!1){const l=document.getElementById("seccion_importar"),t=document.getElementById("seccion_registro"),r=document.querySelector(".contenedor_principal");l.style.display=e==="importar"?"block":"none",t.style.display=e==="registro"?"block":"none",e==="registro"&&o&&(limpiarFormulario(),r.innerHTML="")};window.limpiarFormulario=function(){const e=document.getElementById("frm_paciente");e.reset();const o=document.getElementById("url_store").value;e.action=o;const l=document.querySelector('input[name="_method"]');l&&l.remove(),document.getElementById("btn_guardar").value="Registrar",document.getElementById("txt_paciente_hc").value="",document.getElementById("cmb_plan").innerHTML='<option value="">--Seleccione--</option>'};window.trim_cadena=function(e){e&&e.value&&(e.value=e.value.trim())};window.getPlanes=function(e,o){const l=o==="import"?document.getElementById("cmb_plan_import"):document.getElementById("cmb_plan");if(!e){l.innerHTML='<option value="">--Seleccione--</option>';return}fetch(`/convenios/${e}/planes`).then(t=>t.json()).then(t=>{let r='<option value="">-- Seleccione el plan --</option>';t.forEach(n=>{r+=`<option value="${n.id}">${n.nombre}</option>`}),l.innerHTML=r}).catch(t=>console.error("Error:",t))};window.buscar_paciente=function(){let e=document.getElementById("txt_paciente_hc").value.trim();const o=document.querySelector(".contenedor_principal"),l=document.getElementById("url_buscar").value;if(e.length<3){alert("Ingrese al menos 3 caracteres");return}o.innerHTML='<p style="padding:10px;">Buscando coincidencias...</p>',fetch(`${l}?search=${e}`).then(t=>t.json()).then(t=>{if(window.pacientesEncontrados=t,t.length>0){document.getElementById("seccion_registro").style.display="none";let r=`
                    <div style="margin: 20px 0;">
                        <h3>Resultados de la búsqueda:</h3>
                        <table border="1" style="width:100%; border-collapse: collapse; background:white; font-size: 12px;">
                            <thead style="background: #e0e0e0; font-weight:bold;">
                                <tr>
                                    <th style="padding:8px;">Documento</th>
                                    <th style="padding:8px;">Nombre Completo</th>
                                    <th style="padding:8px;">Teléfono</th>
                                    <th style="padding:8px;">Email</th>
                                    <th style="padding:8px;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                `;t.forEach((n,c)=>{r+=`
                        <tr>
                            <td style="padding:8px; text-align:center;">${n.documento}</td>
                            <td style="padding:8px;">${n.nombres} ${n.apellidos}</td>
                            <td style="padding:8px; text-align:center;">${n.telefono||"-"}</td>
                            <td style="padding:8px;">${n.email||"-"}</td>
                            <td style="padding:8px; text-align:center;">
                                <input type="button" class="btnPrincipal" 
                                       value="Seleccionar" 
                                       onclick="seleccionarPaciente(${c})"
                                       style="cursor:pointer; padding: 5px 10px;">
                            </td>
                        </tr>
                    `}),r+="</tbody></table></div>",o.innerHTML=r}else o.innerHTML='<p style="padding:10px; color:red; font-weight:bold;">No se encontraron pacientes con ese criterio.</p>'}).catch(t=>{console.error("Error:",t),o.innerHTML='<p style="color:red;">Error en la búsqueda</p>'})};window.seleccionarPaciente=function(e){const o=window.pacientesEncontrados[e];o&&(cargarDatosPaciente(o),document.querySelector(".contenedor_principal").innerHTML="")};window.validarImportarPacientes=function(){const e=document.getElementById("fileISS"),o=document.getElementById("cmb_plan_import"),l=document.getElementById("url_importar").value,t=document.getElementById("token_csrf").value;if(!o.value){alert("Seleccione un plan para la importación");return}if(e.files.length===0){alert("Seleccione un archivo .csv");return}let r=new FormData;r.append("fileISS",e.files[0]),r.append("cmb_plan",o.value),r.append("_token",t),fetch(l,{method:"POST",body:r}).then(n=>n.json()).then(n=>{n.res==1?(alert(n.mensaje),location.reload()):alert("Error: "+n.error)}).catch(n=>{console.error("Error:",n),alert("Ocurrió un error al procesar el archivo")})};window.cargarDatosPaciente=function(e){mostrarSeccion("registro",!1),document.getElementById("btn_guardar").value="Actualizar Datos";const o=document.getElementById("frm_paciente");o.action=`/legacy/pacientes/${e.id}`;let l=document.querySelector('input[name="_method"]');l?l.value="PUT":(l=document.createElement("input"),l.type="hidden",l.name="_method",l.value="PUT",o.appendChild(l)),document.getElementById("cmb_tipo_documento").value=e.tipo_documento||"",document.getElementById("txt_numero_documento").value=e.documento||"";const t=(e.nombres||"").split(" ");document.getElementById("txt_nombre_1").value=t[0]||"",document.getElementById("txt_nombre_2").value=t.slice(1).join(" ")||"";const r=(e.apellidos||"").split(" ");document.getElementById("txt_apellido_1").value=r[0]||"",document.getElementById("txt_apellido_2").value=r.slice(1).join(" ")||"",document.getElementById("txt_fecha_nacimiento").value=e.fecha_nacimiento?e.fecha_nacimiento.split(" ")[0]:"";let n="";e.sexo==="F"&&(n="1"),e.sexo==="M"&&(n="2"),document.getElementById("cmb_sexo").value=n,document.getElementById("txt_telefono").value=e.telefono||"",document.getElementById("txt_email").value=e.email||"",document.getElementById("txt_direccion").value=e.direccion||"",document.getElementById("cmb_pais_nac").value=e.pais_nacimiento_cod||"",document.getElementById("cmb_pais_res").value=e.pais_residencia_cod||"1",document.getElementById("txt_estado_residencia").value=e.estado_residencia||"",document.getElementById("txt_municipio_residencia").value=e.municipio_residencia||"",document.getElementById("cmb_zona_residencia").value=e.zona_residencia||"",e.convenio_id&&(document.getElementById("cmb_convenio").value=e.convenio_id,getPlanes(e.convenio_id,"registro"),setTimeout(()=>{e.plan_id&&(document.getElementById("cmb_plan").value=e.plan_id)},500)),document.getElementById("cmb_tipoUsuario").value=e.tipo_usuario||"",document.getElementById("cmb_rango").value=e.rango||"",document.getElementById("cmb_estado_aseguradora").value=e.estado_aseguradora||"",document.getElementById("cmb_exento_cuota").value=e.exento_cuota==1||e.exento_cuota=="Si"?"1":"2",document.getElementById("txt_observ_paciente").value=e.observaciones||""};
